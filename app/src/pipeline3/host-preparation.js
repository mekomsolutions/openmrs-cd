"use strict";

/**
 * Main script of the 'host preparation' stage.
 *
 */

const fs = require("fs");
const path = require("path");
const _ = require("lodash");

const utils = require("../utils/utils");
const model = require("../utils/model");
const cst = require("../const");
const config = require(cst.CONFIGPATH);
const db = require(cst.DBPATH);

const scripts = require("./scripts");

//
//  Fetching the instance definition based on the provided UUID
//
var instanceDef = db.getInstanceDefinition(
  process.env[config.varInstanceUuid()]
);
if (_.isEmpty(instanceDef)) {
  throw new Error("Illegal argument: empty or unexisting instance definition.");
}

//
//  Host metadata
//
var ssh = instanceDef.deployment.host.value; // TODO this should be extracted based on the host type
var hostDir = instanceDef.deployment.hostDir;

//
//  Building the script
//
var script = new model.Script();
script.type = "#!/bin/bash";
script.headComment = "# Autogenerated script for the CD host preparation...";
script.body = "set -e\n";

// 'artifacts'

if (process.env[config.varArtifactsChanges()] === "true") {
  var hostArtifactsDir = hostDir + "/artifacts";
  script.body += scripts.remote(ssh, scripts.initFolder(hostArtifactsDir));
  Object.assign(ssh, { remoteDst: true });
  script.body += scripts.rsync(
    ssh,
    config.getCDArtifactsDirPath(instanceDef.uuid),
    hostArtifactsDir,
    true
  );
}

// 'deployment'

if (process.env[config.varDeploymentChanges()] === "true") {
  if (instanceDef.deployment.type === "docker") {
    var docker = instanceDef.deployment.value;
    // TODO: most likely a `docker login` here
    script.body += scripts.remote(
      ssh,
      "docker pull " + docker.image + ":" + docker.tag + "\n"
    );
  }
}

// 'data'

if (process.env[config.varDataChanges()] === "true") {
  for (var index in instanceDef.data) {
    var hostDataDir = hostDir + "/data";
    var data = instanceDef.data[index];
    if (data.type === "instance") {
      // Retrieve the data directory of the other instance
      var hostSourceDataDir =
        db.getInstanceDefinition(data.value.uuid).deployment.hostDir + "/data";
      // Source and destination are both on the remote host
      Object.assign(ssh, { remoteDst: true, remoteSrc: true });
      script.body += scripts.rsync(ssh, hostSourceDataDir, hostDataDir);
    }
  }
}

//
//  Saving the script in the current build dir.
//
fs.writeFileSync(
  path.resolve(config.getBuildDirPath(), config.getHostPrepareScriptName()),
  utils.getScriptAsString(script)
);
fs.chmodSync(
  path.resolve(config.getBuildDirPath(), config.getHostPrepareScriptName()),
  "0755"
);
